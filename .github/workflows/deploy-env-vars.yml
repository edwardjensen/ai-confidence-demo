name: Deploy Environment Variables to Cloudflare

on:
  workflow_dispatch: # Manual trigger

jobs:
  deploy-env-vars:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '24.x'

    - name: Install dependencies
      run: npm ci

    - name: Build project
      run: npm run build

    - name: Install Wrangler
      run: npm install -g wrangler

    - name: Set OpenRouter API Key
      run: |
        wrangler pages secret put OPENROUTER_API_KEY_V2 --project-name=${{ secrets.CLOUDFLARE_PROJECT_NAME }} <<< "${{ secrets.OPENROUTER_API_KEY_V2 }}"
      env:
        CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

    - name: Set OpenAI API Key
      run: |
        wrangler pages secret put OPENAI_EMBEDDINGS_API_KEY --project-name=${{ secrets.CLOUDFLARE_PROJECT_NAME }} <<< "${{ secrets.OPENAI_EMBEDDINGS_API_KEY }}"
      env:
        CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

    - name: Verify deployment
      run: |
        echo "🔍 Verifying environment variables..."
        wrangler pages secret list --project-name=${{ secrets.CLOUDFLARE_PROJECT_NAME }}
        echo "✅ Environment variables deployed successfully!"
        echo "🔐 API keys are now securely stored in Cloudflare Pages"
      env:
        CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

    - name: Trigger Pages deployment to pick up new secrets
      run: |
        echo "🔄 Triggering Pages deployment to apply new secrets..."
        wrangler pages deployment create dist --project-name=${{ secrets.CLOUDFLARE_PROJECT_NAME }} --commit-dirty=true
      env:
        CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}