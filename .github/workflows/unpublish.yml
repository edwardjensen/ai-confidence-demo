name: Redirect Site to Personal Website

on:
  schedule:
    # Run daily at 07:00 UTC
    - cron: '0 7 * * *'
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "confirm" to redirect the site'
        required: true
        type: string

jobs:
  redirect:
    runs-on: ubuntu-latest
    name: Redirect AI Confidence Demo

    steps:
      - name: âœ… Validate manual trigger
        if: github.event_name == 'workflow_dispatch'
        run: |
          if [ "${{ github.event.inputs.confirm }}" != "confirm" ]; then
            echo "âŒ Redirect operation not confirmed. Please type 'confirm' to proceed."
            exit 1
          fi
          echo "âœ… Manual redirect confirmed"

      - name: ðŸ“ Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '22.x'
          cache: 'npm'

      - name: ðŸ”§ Install Wrangler CLI
        run: npm install -g wrangler

      - name: ï¿½ Create redirect configuration
        run: |
          echo "ï¿½ Creating _redirects file to redirect all traffic to https://www.edwardjensen.net"
          mkdir -p redirect-build
          echo "/* https://www.edwardjensen.net 302" > redirect-build/_redirects
          echo "ï¿½ Created _redirects file:"
          cat redirect-build/_redirects

      - name: ï¿½ Deploy redirect to Cloudflare Pages
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "ðŸš€ Deploying redirect configuration to Cloudflare Pages..."
          
          wrangler pages deploy redirect-build \
            --project-name=${{ secrets.CLOUDFLARE_PROJECT_NAME }} \
            --compatibility-date=2024-01-01
          
          echo "âœ… Successfully deployed redirect configuration"

      - name: ðŸ“ Create redirect summary
        run: |
          echo "## ï¿½ Redirect Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Project**: ${{ secrets.CLOUDFLARE_PROJECT_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Redirected at**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "- **Redirect Target**: https://www.edwardjensen.net" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.event_name }}" = "schedule" ]; then
            echo "ðŸ•°ï¸ **Reason**: Scheduled daily redirect" >> $GITHUB_STEP_SUMMARY
          else
            echo "ðŸ‘¤ **Reason**: Manual trigger" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Status**: Successfully redirected to personal website" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ“§ Notify on scheduled redirect
        if: github.event_name == 'schedule'
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            
            // Create an issue to notify about the scheduled redirect
            await github.rest.issues.create({
              owner,
              repo,
              title: `ï¿½ AI Confidence Demo automatically redirected - ${new Date().toISOString().split('T')[0]}`,
              body: `## Scheduled Redirect Notification\n\nThe AI Confidence Demo has been automatically redirected to https://www.edwardjensen.net as part of the daily cleanup schedule.\n\n**Time**: ${new Date().toISOString()}\n**Trigger**: Scheduled cron job (07:00 UTC)\n**Redirect Type**: 302 (Temporary Redirect)\n\n---\n\nTo restore the original demo, run the "Deploy to Cloudflare Pages" workflow manually.`,
              labels: ['automated', 'deployment']
            });